<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GIS: GIS.DbaseReader.DbaseIndex.cs Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Packages</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<h1>GIS.DbaseReader.DbaseIndex.cs</h1><a href="GIS_8DbaseReader_8DbaseIndex_8cs.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//</span>
00002 <span class="comment">//DbaseIndex.cs</span>
00003 <span class="comment">//</span>
00004 
00024 
00025 <span class="keyword">using</span> System;
00026 <span class="keyword">using</span> System.IO;
00027 
00028 <span class="keyword">namespace </span>ShapeDotNet.GIS.DbaseReader
00029 {
<a name="l00034"></a><a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10">00034</a>     <span class="keyword">public</span> <span class="keyword">enum</span> <a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10">FieldType</a> : byte
00035     {
00036         <a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10a0">C</a> = 0x43, <a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10a1">D</a> = 0x44, <a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10a2">F</a> = 0x46, <a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10a3">N</a> = 0x4E, <a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10a4">L</a> = 0x4C,
00037         <a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10a5">c</a> = 0x63, <a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10a6">d</a> = 0x64, <a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10a7">f</a> = 0x66, <a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10a8">n</a> = 0x6E, <a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10a9">l</a> = 0x6C,
00038     };
00039 
<a name="l00045"></a><a class="code" href="classShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex.html">00045</a>     <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex.html">DbaseIndex</a>
00046     {
00047         
<a name="l00048"></a><a class="code" href="classShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex.html#ShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndexp0">00048</a>         <span class="keyword">protected</span> string[] _FieldNames;
<a name="l00049"></a><a class="code" href="classShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex.html#ShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndexp1">00049</a>         <span class="keyword">protected</span> <a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10">FieldType</a>[] _FieldTypes;
<a name="l00050"></a><a class="code" href="classShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex.html#ShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndexp2">00050</a>         <span class="keyword">protected</span> byte[] _FieldLengths;
<a name="l00051"></a><a class="code" href="classShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex.html#ShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndexp3">00051</a>         <span class="keyword">protected</span> uint _RecordCount;
<a name="l00052"></a><a class="code" href="classShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex.html#ShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndexp4">00052</a>         <span class="keyword">protected</span> ushort _RecordLength;
<a name="l00053"></a><a class="code" href="classShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex.html#ShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndexp5">00053</a>         <span class="keyword">protected</span> uint _RecordStart;
<a name="l00054"></a><a class="code" href="classShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex.html#ShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndexp6">00054</a>         <span class="keyword">protected</span> uint _FieldCount; 
<a name="l00055"></a><a class="code" href="classShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex.html#ShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndexp7">00055</a>         <span class="keyword">protected</span> string _Filename; 
00056 
00057         <span class="keyword">private</span> byte _DbType;
00058         <span class="keyword">private</span> byte _UpdateYear;
00059         <span class="keyword">private</span> byte _UpdateMonth;
00060         <span class="keyword">private</span> byte _UpdateDay;
00061         <span class="keyword">private</span> ushort _HeaderLength;
00062 
<a name="l00063"></a><a class="code" href="classShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex.html#ShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndexa0">00063</a>         <span class="keyword">public</span> <a class="code" href="classShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex.html">DbaseIndex</a>( string filename )
00064         {
00065             ReadHeader( filename );
00066         }
00067 
00068         <span class="keyword">private</span> <span class="keywordtype">void</span> ReadHeader( string filename )
00069         {
00070             
00071             filename            = filename.Remove( filename.Length - 4, 4 );
00072             filename            += <span class="stringliteral">".dbf"</span>;
00073             _Filename           = filename;
00074             
00075             FileStream fs       = <span class="keyword">new</span> FileStream( filename, FileMode.Open );
00076             BinaryReader br     = <span class="keyword">new</span> BinaryReader( fs );
00077             byte checkByte;
00078             byte bbuffer;
00079 
00080             _DbType = br.ReadByte();
00081             
00082             <span class="keywordflow">if</span> ( _DbType == 0x03 )
00083             {
00084                 _UpdateYear     = br.ReadByte();
00085                 _UpdateMonth    = br.ReadByte();
00086                 _UpdateDay      = br.ReadByte();
00087                 _RecordCount    = br.ReadUInt32();
00088                 _HeaderLength   = br.ReadUInt16();
00089                 _RecordLength   = br.ReadUInt16();
00090 
00091                 <span class="comment">// Header size minus terminator char divided by length of</span>
00092                 <span class="comment">// a field descriptor minus 1 to adjust for the file descriptor.</span>
00093                 _FieldCount     = (uint) ( ( _HeaderLength - 1 ) / 32 ) - 1;
00094                 
00095                 _FieldNames     = <span class="keyword">new</span> string[ _FieldCount ];
00096                 _FieldTypes     = <span class="keyword">new</span> <a class="code" href="namespaceShapeDotNet_1_1GIS_1_1DbaseReader.html#a10">FieldType</a>[ _FieldCount ];
00097                 _FieldLengths   = <span class="keyword">new</span> byte[ _FieldCount ];
00098 
00099                 <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> a=0; a &lt; _FieldCount; ++a )
00100                 {
00101                     fs.Seek( 32 + (32 * a ), 0 );
00102 
00103                     <span class="comment">// Has to be read as byte and converted to char</span>
00104                     <span class="comment">// because a 0x9e is appended to the end of some</span>
00105                     <span class="comment">// field descriptors and it throws off br.ReadChars( x )</span>
00106                     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> b=0; b &lt; 11; ++b )
00107                     {
00108                         bbuffer = br.ReadByte();
00109                         _FieldNames[ a ] += ( <span class="keywordtype">char</span> ) bbuffer;
00110                     }
00111 
00112                     _FieldTypes[ a ] = ( FieldType ) br.ReadByte();
00113                     br.ReadBytes( 4 ); <span class="comment">// field address in memory...??</span>
00114                     _FieldLengths[ a ] = br.ReadByte();
00115                 }
00116             }
00117 
00118             <span class="comment">// Field descriptors are 32 bytes each + 32 bytes for the file </span>
00119             <span class="comment">// descriptor + 1 byte for the header record terminator (0x0D)</span>
00120             _RecordStart        = ( _FieldCount * 32 ) + 32 + 1;
00121             
00122             fs.Seek( _RecordStart - 1, 0 );
00123             
00124             checkByte = br.ReadByte(); <span class="comment">// should be 0x0D (13)</span>
00125 
00126             br.Close();
00127             fs.Close();
00128         }
00129 
00130         
00135         <span class="keyword">public</span> string[] FieldNames
<a name="l00136"></a><a class="code" href="classShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex.html#ShapeDotNet_1_1GIS_1_1DbaseReader_1_1DbaseIndex00">00136</a>         {
00137             get
00138             {
00139                 <span class="keywordflow">return</span> _FieldNames;
00140             }
00141         }
00142     }
00143 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Feb 10 17:52:24 2004 for GIS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
